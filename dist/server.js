/*! For license information please see server.js.LICENSE.txt */
(()=>{var t={86:t=>{"use strict";t.exports=require("ws")},106:t=>{"use strict";t.exports=require("zlib")},252:t=>{"use strict";t.exports=require("express")},329:(t,e,r)=>{function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function n(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,a(i.key),i)}}function a(t){var e=function(t){if("object"!=i(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=i(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==i(e)?e:e+""}var o=r(903).v4,s=function(){return t=function t(e,r,i,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.id=o(),this.x=e,this.y=r,this.radius=i,this.color=n,this.originalColor=n,this.vx=0,this.vy=0,this.maxSpeed=10,this.originalMaxSpeed=this.maxSpeed,this.targetX=e,this.targetY=r,this.lastUpdateTime=Date.now(),this.input=null,this.dirX=0,this.dirY=0,this.angle=0,this.distance=0,this.mouseActive=!1,this.d_x=0,this.d_y=0,this.slippery=!1,this.collisionCache=new Map,this.cacheTimeout=100,this.lastCacheCleanup=Date.now(),this.stuckCounter=0,this.lastPosition={x:e,y:r},this.isDead=!1,this.currentMapId=null,this.lastTeleporterIdUsed=null,this.isOnTeleporter=!1,this.isFullyInsideTeleporter=!1,this.lastTeleporterCodeUsed=null,this.teleporterCooldown=0,this.canTeleport=!0,this.wasFullyOutsideTeleporter=!0},(e=[{key:"setInput",value:function(t){this.input=t,this.setupInputHandlers()}},{key:"setupInputHandlers",value:function(){var t=this;this.input&&(this.input.on("movement",(function(e){t.dirX=e.dirX,t.dirY=e.dirY,t.angle=e.angle,t.distance=e.distance,t.mouseActive=e.mouseActive,t.d_x=e.d_x,t.d_y=e.d_y})),this.input.on("movementUpdate",(function(e){t.d_x=e.d_x,t.d_y=e.d_y,t.angle=e.angle,t.slippery=e.slippery})),this.input.on("mousemove",(function(e,r){t.targetX=e,t.targetY=r})))}},{key:"update",value:function(t,e){this.collisionCache.clear();var r=e.mapGrids.get(this.currentMapId);if(r){this.teleporterCooldown>0&&this.teleporterCooldown--,this.isOnTeleporter,this.wasFullyOutsideTeleporter;var i=Date.now();if(this.lastUpdateTime,this.lastUpdateTime=i,Math.sqrt(Math.pow(this.x-this.lastPosition.x,2)+Math.pow(this.y-this.lastPosition.y,2))<.1&&(Math.abs(this.vx)>.1||Math.abs(this.vy)>.1)?this.stuckCounter++:this.stuckCounter=0,this.lastPosition={x:this.x,y:this.y},i-this.lastCacheCleanup>500&&(this.collisionCache.clear(),this.lastCacheCleanup=i),this.isDead)return this.vx=0,void(this.vy=0);if(this.input)this.vx=this.d_x*this.maxSpeed,this.vy=this.d_y*this.maxSpeed;else{var n=this.targetX-this.x,a=this.targetY-this.y,o=Math.sqrt(n*n+a*a);if(!(o>1))return this.x=this.targetX,this.y=this.targetY,this.vx=0,void(this.vy=0);var s=Math.min(o/150,1),l=n/o,h=a/o;this.vx=l*this.maxSpeed*s,this.vy=h*this.maxSpeed*s}if(this.stuckCounter>3)for(var u=0,c=[{x:.5,y:0},{x:-.5,y:0},{x:0,y:.5},{x:0,y:-.5}];u<c.length;u++){var f=c[u];if(!this.collidesWithWall(this.x+f.x,this.y+f.y,t)){this.x+=f.x,this.y+=f.y,this.stuckCounter=0;break}}var p=this.x+this.vx,d=this.y+this.vy,y=!this.collidesWithWall(p,this.y,t),v=!this.collidesWithWall(this.x,d,t);if(y&&(this.x=p),v&&(this.y=d),y||v||this.handleSliding(t),!this.input||y&&v||this.input.setSlippery(!1),this.isOnTeleporter=r.checkTeleporterCollision(this),this.isFullyInsideTeleporter=this.isOnTeleporter&&r.isFullyInsideTeleporter(this),this.wasFullyOutsideTeleporter=r.isFullyOutsideTeleporter(this),this.isOnTeleporter,this.wasFullyOutsideTeleporter&&(this.canTeleport||(this.canTeleport=!0)),this.isFullyInsideTeleporter&&0===this.teleporterCooldown&&this.canTeleport){var m=r.getTeleporterAt(this.x,this.y);m&&m.code&&e&&"function"==typeof e.handlePlayerTeleport&&(e.handlePlayerTeleport(this.id,m),this.lastTeleporterCodeUsed=m.code,this.teleporterCooldown=60,this.canTeleport=!1)}}}},{key:"handleSliding",value:function(t){for(var e=.9;e>=.1;e-=.1){var r=this.x+this.vx*e;if(!this.collidesWithWall(r,this.y,t)){this.x=r;break}}for(var i=.9;i>=.1;i-=.1){var n=this.y+this.vy*i;if(!this.collidesWithWall(this.x,n,t)){this.y=n;break}}if(Math.abs(this.vx)>.1&&Math.abs(this.vy)>.1)for(var a=.9;a>=.1;a-=.1){var o=this.x+this.vx*a,s=this.y+this.vy*a;if(!this.collidesWithWall(o,s,t)){this.x=o,this.y=s;break}}}},{key:"collidesWithWall",value:function(t,e,r){var i="".concat(t.toFixed(1),",").concat(e.toFixed(1));if(this.collisionCache.has(i))return this.collisionCache.get(i);var n=this.spatialCheckCollision(t,e,r);return this.collisionCache.set(i,n),n}},{key:"spatialCheckCollision",value:function(t,e,r){var i=r.tileSize,n=t-this.radius,a=t+this.radius,o=e-this.radius,s=e+this.radius,l=Math.floor(n/i),h=Math.floor(a/i),u=Math.floor(o/i),c=Math.floor(s/i);return this.checkTilesInRange(l,h,u,c,r)}},{key:"checkTilesInRange",value:function(t,e,r,i,n){if(e<0||t>=n.width||i<0||r>=n.height)return!1;for(var a=Math.max(0,t);a<=Math.min(e,n.width-1);a++)for(var o=Math.max(0,r);o<=Math.min(i,n.height-1);o++)if(n.isWall(a,o))return!0;return t<0||e>=n.width||r<0||i>=n.height}},{key:"setTarget",value:function(t,e){this.targetX=t,this.targetY=e}},{key:"getPosition",value:function(){return{x:this.x,y:this.y}}},{key:"hitByEnemy",value:function(){this.isDead||(this.isDead=!0,this.color="#FF0000",this.maxSpeed=0)}},{key:"reviveByPlayer",value:function(){this.isDead&&(this.isDead=!1,this.color=this.originalColor,this.maxSpeed=this.originalMaxSpeed)}},{key:"reset",value:function(){this.isDead=!1,this.color=this.originalColor,this.maxSpeed=this.originalMaxSpeed,this.vx=0,this.vy=0,this.stuckCounter=0,this.mouseActive=!1,this.targetX=this.x,this.targetY=this.y,this.dirX=0,this.dirY=0,this.d_x=0,this.d_y=0,this.lastTeleporterCodeUsed=null,this.isOnTeleporter=!1,this.isFullyInsideTeleporter=!1,this.teleporterCooldown=0,this.collisionCache.clear(),this.canTeleport=!0,this.wasFullyOutsideTeleporter=!0}},{key:"serialize",value:function(){return{id:this.id,x:this.x,y:this.y,radius:this.radius,color:this.color,isDead:this.isDead,currentMapId:this.currentMapId}}}])&&n(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();t.exports={Player:s}},352:t=>{function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e(t)}function r(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return i(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?i(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,a=function(){};return{s:a,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,l=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return s=t.done,t},e:function(t){l=!0,o=t},f:function(){try{s||null==r.return||r.return()}finally{if(l)throw o}}}}function i(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,i=Array(e);r<e;r++)i[r]=t[r];return i}function n(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,a(i.key),i)}}function a(t){var r=function(t){if("object"!=e(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,"string");if("object"!=e(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(r)?r:r+""}var o=function(){return t=function t(e,r,i){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.width=e,this.height=r,this.cellSize=i,this.inverseCellSize=1/i,this.cellsX=Math.ceil(e/i),this.cellsY=Math.ceil(r/i),this.maxCellX=this.cellsX-1,this.maxCellY=this.cellsY-1,this.cells=new Array(this.cellsX*this.cellsY).fill(null).map((function(){return{entities:new Set,isWall:!1,isSafeZone:!1,isTeleporter:!1,teleporterInfo:null}})),this.entities=new Map},(e=[{key:"getCellIndex",value:function(t,e){var r=Math.min(Math.max(Math.floor(t*this.inverseCellSize),0),this.maxCellX),i=Math.min(Math.max(Math.floor(e*this.inverseCellSize),0),this.maxCellY);return r*this.cellsY+i}},{key:"getCellCoords",value:function(t,e){return{x:Math.min(Math.max(Math.floor(t*this.inverseCellSize),0),this.maxCellX),y:Math.min(Math.max(Math.floor(e*this.inverseCellSize),0),this.maxCellY)}}},{key:"initializeMapData",value:function(t){for(var e=0;e<this.cells.length;e++)this.cells[e].isWall=!1,this.cells[e].isSafeZone=!1,this.cells[e].isTeleporter=!1,this.cells[e].teleporterInfo=null;for(var r=0;r<t.height;r++)for(var i=0;i<t.width;i++){var n=t.getTileType(i,r);if(null!=n)for(var a=i*t.tileSize,o=r*t.tileSize,s=a+t.tileSize,l=o+t.tileSize,h=Math.floor(a*this.inverseCellSize),u=Math.floor(o*this.inverseCellSize),c=Math.floor((s-1e-4)*this.inverseCellSize),f=Math.floor((l-1e-4)*this.inverseCellSize),p=Math.max(0,Math.min(h,this.maxCellX)),d=Math.max(0,Math.min(u,this.maxCellY)),y=Math.max(0,Math.min(c,this.maxCellX)),v=Math.max(0,Math.min(f,this.maxCellY)),m=p;m<=y;m++)for(var g=d;g<=v;g++){var b=m*this.cellsY+g;if(0===n)this.cells[b].isWall=!0;else if(2===n)this.cells[b].isSafeZone=!0;else if(3===n){this.cells[b].isTeleporter=!0;var x=t.getTeleporter(i,r);x&&(this.cells[b].teleporterInfo={tileX:i,tileY:r,code:x.code,mapId:x.mapId})}}}}},{key:"insert",value:function(t){for(var e=t.radius||0,r=Math.min(Math.max(Math.floor((t.x-e)*this.inverseCellSize),0),this.maxCellX),i=Math.min(Math.max(Math.floor((t.y-e)*this.inverseCellSize),0),this.maxCellY),n=Math.min(Math.max(Math.floor((t.x+e)*this.inverseCellSize),0),this.maxCellX),a=Math.min(Math.max(Math.floor((t.y+e)*this.inverseCellSize),0),this.maxCellY),o=[],s=r;s<=n;s++)for(var l=i;l<=a;l++){var h=s*this.cellsY+l;this.cells[h].entities.add(t.id),o.push(h)}return this.entities.set(t.id,{entity:t,minX:r,minY:i,maxX:n,maxY:a,cellIndices:o}),o}},{key:"remove",value:function(t){var e=this.entities.get(t);if(e){var i,n=r(e.cellIndices);try{for(n.s();!(i=n.n()).done;){var a=i.value;this.cells[a]&&this.cells[a].entities.delete(t)}}catch(t){n.e(t)}finally{n.f()}this.entities.delete(t)}}},{key:"update",value:function(t){return this.remove(t.id),this.insert(t)}},{key:"getNearbyEntities",value:function(t){var e=this.entities.get(t.id);if(!e)return[];var i,n=new Set,a=r(e.cellIndices);try{for(a.s();!(i=a.n()).done;){var o,s=i.value,l=r(this.cells[s].entities);try{for(l.s();!(o=l.n()).done;){var h=o.value;h!==t.id&&n.add(h)}}catch(t){l.e(t)}finally{l.f()}}}catch(t){a.e(t)}finally{a.f()}return Array.from(n)}},{key:"_checkOverlapWithCellProperty",value:function(t,e,r,i){for(var n=Math.floor(t*this.inverseCellSize),a=Math.floor(e*this.inverseCellSize),o=Math.ceil(r*this.inverseCellSize),s=Math.max(0,n-o),l=Math.max(0,a-o),h=Math.min(this.maxCellX,n+o),u=Math.min(this.maxCellY,a+o),c=s;c<=h;c++)for(var f=l;f<=u;f++){var p=c*this.cellsY+f,d=this.cells[p];if(d&&i(d)){var y=c*this.cellSize,v=f*this.cellSize,m=y+this.cellSize,g=v+this.cellSize;if(t-r<m&&t+r>y&&e-r<g&&e+r>v)return!0}}return!1}},{key:"checkWallCollision",value:function(t){return t.x-t.radius<0||t.x+t.radius>this.width||t.y-t.radius<-2||t.y+t.radius>this.height||this._checkOverlapWithCellProperty(t.x,t.y,t.radius,(function(t){return t.isWall}))}},{key:"checkSafeZoneCollision",value:function(t){return this._checkOverlapWithCellProperty(t.x,t.y,t.radius,(function(t){return t.isSafeZone}))}},{key:"queryArea",value:function(t,e,i){for(var n=i||0,a=Math.min(Math.max(Math.floor((t-n)*this.inverseCellSize),0),this.maxCellX),o=Math.min(Math.max(Math.floor((e-n)*this.inverseCellSize),0),this.maxCellY),s=Math.min(Math.max(Math.floor((t+n)*this.inverseCellSize),0),this.maxCellX),l=Math.min(Math.max(Math.floor((e+n)*this.inverseCellSize),0),this.maxCellY),h=new Set,u=a;u<=s;u++)for(var c=o;c<=l;c++){var f,p=u*this.cellsY+c,d=r(this.cells[p].entities);try{for(d.s();!(f=d.n()).done;){var y=f.value;h.add(y)}}catch(t){d.e(t)}finally{d.f()}}return Array.from(h)}},{key:"clear",value:function(){this.cells.forEach((function(t){t.entities.clear()})),this.entities.clear()}},{key:"getGridStats",value:function(){var t,e=this.entities.size,i=0,n=0,a=r(this.cells);try{for(a.s();!(t=a.n()).done;){var o=t.value;o.entities.size>0&&(i++,n=Math.max(n,o.entities.size))}}catch(t){a.e(t)}finally{a.f()}return{totalEntities:e,occupiedCells:i,maxEntitiesInCell:n,totalCells:this.cellsX*this.cellsY}}},{key:"bulkInsert",value:function(t){if(t&&0!==t.length){var e,i=r(t);try{for(i.s();!(e=i.n()).done;){var n=e.value;this.entities.has(n.id)&&this.remove(n.id)}}catch(t){i.e(t)}finally{i.f()}var a,o=r(t);try{for(o.s();!(a=o.n()).done;){var s=a.value;this.insert(s)}}catch(t){o.e(t)}finally{o.f()}}}},{key:"isValidSpawnPosition",value:function(t,e,r){return!(t-r<0||t+r>this.width||e-r<0||e+r>this.height||this._checkOverlapWithCellProperty(t,e,r,(function(t){return t.isWall||t.isSafeZone||t.isTeleporter})))}},{key:"checkTeleporterCollision",value:function(t){var e=t.x,r=t.y,i=t.radius||0,n=this.getCellIndex(e,r);if(n>=0&&n<this.cells.length&&this.cells[n].isTeleporter)return!0;for(var a=0;a<8;a++){var o=a/8*Math.PI*2,s=e+Math.cos(o)*i,l=r+Math.sin(o)*i,h=this.getCellIndex(s,l);if(h>=0&&h<this.cells.length&&this.cells[h].isTeleporter)return!0}return!1}},{key:"getTeleporterAt",value:function(t,e){var r=Math.floor(t*this.inverseCellSize),i=Math.floor(e*this.inverseCellSize);if(r<0||i<0||r>this.maxCellX||i>this.maxCellY)return null;var n=r*this.cellsY+i,a=this.cells[n];return a&&a.isTeleporter&&a.teleporterInfo?a.teleporterInfo:null}},{key:"isFullyOutsideTeleporter",value:function(t){var e=t.x,r=t.y,i=t.radius||0,n=this.getCellIndex(e,r);if(n>=0&&n<this.cells.length&&this.cells[n].isTeleporter)return!1;for(var a=0;a<12;a++){var o=a/12*Math.PI*2,s=e+Math.cos(o)*i,l=r+Math.sin(o)*i,h=this.getCellIndex(s,l);if(h>=0&&h<this.cells.length&&this.cells[h].isTeleporter)return!1}return!0}},{key:"isFullyInsideTeleporter",value:function(t){return!!this.getTeleporterAt(t.x,t.y)}}])&&n(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();t.exports&&(t.exports=o)},422:(t,e,r)=>{function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function n(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,i)}return r}function a(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?n(Object(r),!0).forEach((function(e){d(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):n(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function o(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(o=function(){return!!t})()}function s(t,e,r,i){var n=l(h(1&i?t.prototype:t),e,r);return 2&i&&"function"==typeof n?function(t){return n.apply(r,t)}:n}function l(){return l="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,r){var i=function(t,e){for(;!{}.hasOwnProperty.call(t,e)&&null!==(t=h(t)););return t}(t,e);if(i){var n=Object.getOwnPropertyDescriptor(i,e);return n.get?n.get.call(arguments.length<3?t:r):n.value}},l.apply(null,arguments)}function h(t){return h=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},h(t)}function u(t,e){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},u(t,e)}function c(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=f(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var i=0,n=function(){};return{s:n,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw a}}}}function f(t,e){if(t){if("string"==typeof t)return p(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?p(t,e):void 0}}function p(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,i=Array(e);r<e;r++)i[r]=t[r];return i}function d(t,e,r){return(e=g(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function y(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function v(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,g(i.key),i)}}function m(t,e,r){return e&&v(t.prototype,e),r&&v(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function g(t){var e=function(t){if("object"!=i(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=i(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==i(e)?e:e+""}var b=r(903).v4,x=r(352),w={1:{name:"Basic",color:"#808080",outlineColor:"#000000"},2:{name:"Sniper",color:"#8B0000",outlineColor:"#000000"}},M=function(){return m((function t(e,r,i,n,a,o){y(this,t),this.id="bullet_".concat(b()),this.x=e,this.y=r,this.prevX=e,this.prevY=r,this.radius=a,this.speed=o,this.color="#FFFF00",this.outlineColor="#FF8C00";var s=i-e,l=n-r,h=Math.sqrt(s*s+l*l);this.vx=s/h*o,this.vy=l/h*o,this.lastUpdateTime=Date.now(),this.isActive=!0}),[{key:"update",value:function(t,e){if(this.isActive){var r=Date.now(),i=(r-this.lastUpdateTime)/16.67;this.lastUpdateTime=r,this.prevX=this.x,this.prevY=this.y;var n=this.x+this.vx*i,a=this.y+this.vy*i,o={id:this.id,x:n,y:a,radius:this.radius};e.checkWallCollision(o)||e.checkSafeZoneCollision(o)||e.checkTeleporterCollision(o)||n-this.radius<0||n+this.radius>t.width*t.tileSize||a-this.radius<0||a+this.radius>t.height*t.tileSize?this.isActive=!1:(this.x=n,this.y=a,e.update(this))}}},{key:"serialize",value:function(){return{id:this.id,x:this.x,y:this.y,prevX:this.prevX,prevY:this.prevY,radius:this.radius,isActive:this.isActive}}},{key:"addToGrid",value:function(t){t.insert(this)}},{key:"removeFromGrid",value:function(t){t.remove(this.id)}}])}(),S=function(){return m((function t(e,r,i,n){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;y(this,t),this.id="".concat(a,"_").concat(t.counter++),this.type=a,this.x=e,this.y=r,this.prevX=e,this.prevY=r,this.radius=i,this.color=w[a].color,this.outlineColor=w[a].outlineColor;var o=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1},{x:1,y:1},{x:-1,y:1},{x:1,y:-1},{x:-1,y:-1}],s=o[Math.floor(Math.random()*o.length)],l=.4*Math.random()-.2,h=.4*Math.random()-.2,u=s.x+l,c=s.y+h,f=Math.sqrt(u*u+c*c);this.vx=u/f*n,this.vy=c/f*n,this.speed=n,this.lastUpdateTime=Date.now()}),[{key:"update",value:function(t,e){var r=Date.now(),i=(r-this.lastUpdateTime)/16.67;this.lastUpdateTime=r,this.prevX=this.x,this.prevY=this.y;var n=!1,a=this.x+this.vx*i,o=this.y+this.vy*i,s={id:this.id,x:a,y:this.y,radius:this.radius};if(e.checkWallCollision(s)||e.checkSafeZoneCollision(s)||e.checkTeleporterCollision(s)){this.vx=-this.vx,this.vx+=.2*(Math.random()-.5),this.vy+=.2*(Math.random()-.5);var l=Math.sqrt(this.vx*this.vx+this.vy*this.vy);this.vx=this.vx/l*this.speed,this.vy=this.vy/l*this.speed}else this.x=a,n=!0;var h={id:this.id,x:this.x,y:o,radius:this.radius};if(e.checkWallCollision(h)||e.checkSafeZoneCollision(h)||e.checkTeleporterCollision(h)){this.vy=-this.vy,this.vx+=.2*(Math.random()-.5),this.vy+=.2*(Math.random()-.5);var u=Math.sqrt(this.vx*this.vx+this.vy*this.vy);this.vx=this.vx/u*this.speed,this.vy=this.vy/u*this.speed}else this.y=o,n=!0;var c={id:this.id,x:this.x,y:this.y,radius:this.radius};if(e.checkWallCollision(c)||e.checkSafeZoneCollision(c)||e.checkTeleporterCollision(c)||this.x-this.radius<0||this.x+this.radius>t.width*t.tileSize||this.y-this.radius<0||this.y+this.radius>t.height*t.tileSize){this.x=this.prevX,this.y=this.prevY,n=!1,this.vx=-this.vx,this.vy=-this.vy,this.vx+=.5*(Math.random()-.5),this.vy+=.5*(Math.random()-.5);var f=Math.sqrt(this.vx*this.vx+this.vy*this.vy);this.vx=this.vx/f*this.speed,this.vy=this.vy/f*this.speed}n&&e.update(this)}},{key:"checkEnemyCollisions",value:function(t){var e,r=[],i=c(t.getNearbyEntities(this));try{for(i.s();!(e=i.n()).done;){var n,a=e.value,o=null===(n=t.entities.get(a))||void 0===n?void 0:n.entity;if(o){var s=this.x-o.x,l=this.y-o.y;Math.sqrt(s*s+l*l)<this.radius+o.radius&&r.push(o)}}}catch(t){i.e(t)}finally{i.f()}return r}},{key:"serialize",value:function(){return{id:this.id,type:this.type,x:this.x,y:this.y,prevX:this.prevX,prevY:this.prevY,radius:this.radius}}},{key:"addToGrid",value:function(t){t.insert(this)}},{key:"removeFromGrid",value:function(t){t.remove(this.id)}}])}();d(S,"counter",0);var C=function(t){function e(t,r,n,a){var s,l,u,c,f=arguments.length>4&&void 0!==arguments[4]?arguments[4]:500,p=arguments.length>5&&void 0!==arguments[5]?arguments[5]:400,d=arguments.length>6&&void 0!==arguments[6]?arguments[6]:100,v=arguments.length>7&&void 0!==arguments[7]?arguments[7]:5,m=arguments.length>8&&void 0!==arguments[8]?arguments[8]:5;return y(this,e),(l=this,u=e,c=[t,r,n,a,2],u=h(u),s=function(t,e){if(e&&("object"==i(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(l,o()?Reflect.construct(u,c||[],h(l).constructor):u.apply(l,c))).detectionRange=f,s.shootingRange=p,s.shootCooldown=0,s.maxShootCooldown=d,s.bulletRadius=v,s.bulletSpeed=m,s.lastTargetX=null,s.lastTargetY=null,s}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&u(t,e)}(e,t),m(e,[{key:"update",value:function(t,r,i){if(s(e,"update",this,3)([t,r]),this.shootCooldown>0&&this.shootCooldown--,i&&0===this.shootCooldown){var n,a=null,o=1/0,l=c(i.players);try{for(l.s();!(n=l.n()).done;){var h=(g=n.value,b=2,function(t){if(Array.isArray(t))return t}(g)||function(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var i,n,a,o,s=[],l=!0,h=!1;try{if(a=(r=r.call(t)).next,0===e){if(Object(r)!==r)return;l=!1}else for(;!(l=(i=a.call(r)).done)&&(s.push(i.value),s.length!==e);l=!0);}catch(t){h=!0,n=t}finally{try{if(!l&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(h)throw n}}return s}}(g,b)||f(g,b)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),u=(h[0],h[1]);if(!u.isDead&&u.currentMapId===i.currentMapId){var p=u.x-this.x,d=u.y-this.y,y=Math.sqrt(p*p+d*d);y<this.detectionRange&&y<o&&(o=y,a=u,this.lastTargetX=u.x,this.lastTargetY=u.y)}}}catch(t){l.e(t)}finally{l.f()}if(a&&null!==this.lastTargetX&&null!==this.lastTargetY&&o<=this.shootingRange){var v=new M(this.x,this.y,this.lastTargetX,this.lastTargetY,this.bulletRadius,this.bulletSpeed);if(i.mapBullets&&i.currentMapId){var m=i.mapBullets.get(i.currentMapId)||new Map;m.set(v.id,v),i.mapBullets.set(i.currentMapId,m),v.addToGrid(r)}this.shootCooldown=this.maxShootCooldown}}var g,b}},{key:"serialize",value:function(){return a(a({},s(e,"serialize",this,3)([])),{},{detectionRange:this.detectionRange,shootingRange:this.shootingRange})}}])}(S);S.initializeGridWithMap=function(t){var e=t.tileSize||64,r=new x(t.width*t.tileSize,t.height*t.tileSize,e);return r.initializeMapData(t),r},S.bulkAddToGrid=function(t,e){if(t&&0!==t.length)return e.bulkInsert(t),e},t.exports={Enemy:S,Sniper:C,Bullet:M,ENEMY_TYPES:w,initializeGridWithMap:S.initializeGridWithMap,bulkAddToGrid:S.bulkAddToGrid}},611:t=>{"use strict";t.exports=require("http")},654:(t,e,r)=>{function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function n(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=o(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var i=0,n=function(){};return{s:n,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,l=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return s=t.done,t},e:function(t){l=!0,a=t},f:function(){try{s||null==r.return||r.return()}finally{if(l)throw a}}}}function a(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var i,n,a,o,s=[],l=!0,h=!1;try{if(a=(r=r.call(t)).next,0===e){if(Object(r)!==r)return;l=!1}else for(;!(l=(i=a.call(r)).done)&&(s.push(i.value),s.length!==e);l=!0);}catch(t){h=!0,n=t}finally{try{if(!l&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(h)throw n}}return s}}(t,e)||o(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(t,e){if(t){if("string"==typeof t)return s(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?s(t,e):void 0}}function s(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,i=Array(e);r<e;r++)i[r]=t[r];return i}function l(){"use strict";l=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",h=a.toStringTag||"@@toStringTag";function u(t,e,r,i){return Object.defineProperty(t,e,{value:r,enumerable:!i,configurable:!i,writable:!i})}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function c(e,r,i,n){var a=r&&r.prototype instanceof d?r:d,o=Object.create(a.prototype);return u(o,"_invoke",function(e,r,i){var n=1;return function(a,o){if(3===n)throw Error("Generator is already running");if(4===n){if("throw"===a)throw o;return{value:t,done:!0}}for(i.method=a,i.arg=o;;){var s=i.delegate;if(s){var l=S(s,i);if(l){if(l===p)continue;return l}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if(1===n)throw n=4,i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n=3;var h=f(e,r,i);if("normal"===h.type){if(n=i.done?4:2,h.arg===p)continue;return{value:h.arg,done:i.done}}"throw"===h.type&&(n=4,i.method="throw",i.arg=h.arg)}}}(e,i,new T(n||[])),!0),o}function f(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=c;var p={};function d(){}function y(){}function v(){}var m={};u(m,o,(function(){return this}));var g=Object.getPrototypeOf,b=g&&g(g(I([])));b&&b!==r&&n.call(b,o)&&(m=b);var x=v.prototype=d.prototype=Object.create(m);function w(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function M(t,e){function r(a,o,s,l){var h=f(t[a],t,o);if("throw"!==h.type){var u=h.arg,c=u.value;return c&&"object"==i(c)&&n.call(c,"__await")?e.resolve(c.__await).then((function(t){r("next",t,s,l)}),(function(t){r("throw",t,s,l)})):e.resolve(c).then((function(t){u.value=t,s(u)}),(function(t){return r("throw",t,s,l)}))}l(h.arg)}var a;u(this,"_invoke",(function(t,i){function n(){return new e((function(e,n){r(t,i,e,n)}))}return a=a?a.then(n,n):n()}),!0)}function S(e,r){var i=r.method,n=e.i[i];if(n===t)return r.delegate=null,"throw"===i&&e.i.return&&(r.method="return",r.arg=t,S(e,r),"throw"===r.method)||"return"!==i&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+i+"' method")),p;var a=f(n,e.i,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,p;var o=a.arg;return o?o.done?(r[e.r]=o.value,r.next=e.n,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,p):o:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,p)}function C(t){this.tryEntries.push(t)}function k(e){var r=e[4]||{};r.type="normal",r.arg=t,e[4]=r}function T(t){this.tryEntries=[[-1]],t.forEach(C,this),this.reset(!0)}function I(e){if(null!=e){var r=e[o];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var a=-1,s=function r(){for(;++a<e.length;)if(n.call(e,a))return r.value=e[a],r.done=!1,r;return r.value=t,r.done=!0,r};return s.next=s}}throw new TypeError(i(e)+" is not iterable")}return y.prototype=v,u(x,"constructor",v),u(v,"constructor",y),y.displayName=u(v,h,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===y||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,v):(t.__proto__=v,u(t,h,"GeneratorFunction")),t.prototype=Object.create(x),t},e.awrap=function(t){return{__await:t}},w(M.prototype),u(M.prototype,s,(function(){return this})),e.AsyncIterator=M,e.async=function(t,r,i,n,a){void 0===a&&(a=Promise);var o=new M(c(t,r,i,n),a);return e.isGeneratorFunction(r)?o:o.next().then((function(t){return t.done?t.value:o.next()}))},w(x),u(x,h,"Generator"),u(x,o,(function(){return this})),u(x,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var i in e)r.unshift(i);return function t(){for(;r.length;)if((i=r.pop())in e)return t.value=i,t.done=!1,t;return t.done=!0,t}},e.values=I,T.prototype={constructor:T,reset:function(e){if(this.prev=this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(k),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0][4];if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function i(t){o.type="throw",o.arg=e,r.next=t}for(var n=r.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n],o=a[4],s=this.prev,l=a[1],h=a[2];if(-1===a[0])return i("end"),!1;if(!l&&!h)throw Error("try statement without catch or finally");if(null!=a[0]&&a[0]<=s){if(s<l)return this.method="next",this.arg=t,i(l),!0;if(s<h)return i(h),!1}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i[0]>-1&&i[0]<=this.prev&&this.prev<i[2]){var n=i;break}}n&&("break"===t||"continue"===t)&&n[0]<=e&&e<=n[2]&&(n=null);var a=n?n[4]:{};return a.type=t,a.arg=e,n?(this.method="next",this.next=n[2],p):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),p},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r[2]===t)return this.complete(r[4],r[3]),k(r),p}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r[0]===t){var i=r[4];if("throw"===i.type){var n=i.arg;k(r)}return n}}throw Error("illegal catch attempt")},delegateYield:function(e,r,i){return this.delegate={i:I(e),r,n:i},"next"===this.method&&(this.arg=t),p}},e}function h(t,e,r,i,n,a,o){try{var s=t[a](o),l=s.value}catch(t){return void r(t)}s.done?e(l):Promise.resolve(l).then(i,n)}function u(t){return function(){var e=this,r=arguments;return new Promise((function(i,n){var a=t.apply(e,r);function o(t){h(a,i,n,o,s,"next",t)}function s(t){h(a,i,n,o,s,"throw",t)}o(void 0)}))}}function c(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,f(i.key),i)}}function f(t){var e=function(t){if("object"!=i(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=i(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==i(e)?e:e+""}var p=r(106),d=r(422),y=d.Enemy,v=d.Sniper,m=(d.Bullet,d.ENEMY_TYPES),g=d.initializeGridWithMap,b=(r(329).Player,r(352).Grid,function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.mapManager=e,this.players=new Map,this.connections=new Map,this.mapEnemies=new Map,this.mapBullets=new Map,this.mapGrids=new Map,this.lastUpdateTime=Date.now(),this.updateInterval=null,this._cachedPlayerIds=new Map,this._cachedEnemyIds=new Map,this._cachedBulletIds=new Map,this._playerIdCounter=1,this._enemyIdCounter=1,this._bulletIdCounter=1,this._idMapNeedsUpdate=!0,this._updateCounter=0},e=[{key:"loadMapIfNeeded",value:(o=u(l().mark((function t(e){var r,i;return l().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.mapGrids.has(e)&&this.mapEnemies.has(e)){t.next=13;break}if(r=this.mapManager.getMapById(e)){t.next=5;break}return console.error("Failed to load map: ".concat(e,". Map not found.")),t.abrupt("return",null);case 5:return console.log("Loading map resources for ".concat(e,"...")),i=g(r),this.mapGrids.set(e,i),this.mapEnemies.set(e,new Map),this.mapBullets.set(e,new Map),this.spawnEnemiesForMap(e,r,i),console.log("Map resources for ".concat(e," loaded.")),t.abrupt("return",r);case 13:return t.abrupt("return",this.mapManager.getMapById(e));case 14:case"end":return t.stop()}}),t,this)}))),function(t){return o.apply(this,arguments)})},{key:"spawnEnemiesForMap",value:function(t,e,r){if(e&&r){var i=this.mapEnemies.get(t);if(i){for(var n=e.enemyConfig,o=n.spawnTileType,s=n.types,l=0,h=0,u=Object.entries(s);h<u.length;h++){var c=a(u[h],2),f=c[0],p=c[1],d=p.count,m=p.radius,g=p.minSpeed,b=p.maxSpeed;if("basic"===f)for(var x=0;x<d;x++){var w=e.getValidSpawnPosition(o,m,r);if(w){var M=g+Math.random()*(b-g),S=new y(w.x,w.y,m,M,1);S.addToGrid(r),i.set(S.id,S),l++}}else if("sniper"===f)for(var C=0;C<d;C++){var k=e.getValidSpawnPosition(o,m,r);if(k){var T=g+Math.random()*(b-g),I=new v(k.x,k.y,m,T,p.detectionRange,p.shootingRange,p.maxShootCooldown,p.bulletRadius,p.bulletSpeed);I.addToGrid(r),i.set(I.id,I),l++}}}console.log("Spawned ".concat(l," enemies for map ").concat(t," (Types: ").concat(Object.keys(s).join(", "),")"))}else console.error("Enemy map not initialized for ".concat(t))}else console.error("Cannot spawn enemies for ".concat(t,", map or grid missing."))}},{key:"addPlayer",value:(i=u(l().mark((function t(e,r){var i,n=arguments;return l().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=n.length>2&&void 0!==n[2]?n[2]:"map1",e.currentMapId=i,t.next=4,this.loadMapIfNeeded(i);case 4:this.players.set(e.id,e),this.connections.set(e.id,r),this.broadcastNewPlayer(e),this._idMapNeedsUpdate=!0;case 8:case"end":return t.stop()}}),t,this)}))),function(t,e){return i.apply(this,arguments)})},{key:"removePlayer",value:function(t){var e=this.players.get(t);e&&(this.players.delete(t),this.connections.delete(t),this._cachedPlayerIds.delete(e.id),this._idMapNeedsUpdate=!0,this.broadcastPlayerLeave(t,e.currentMapId))}},{key:"updatePlayerDirection",value:function(t,e,r){var i=this.players.get(t);i&&i.setTarget(e,r)}},{key:"start",value:function(){var t=this;this.updateInterval=setInterval((function(){return t.update()}),16)}},{key:"stop",value:function(){clearInterval(this.updateInterval)}},{key:"update",value:function(){var t=Date.now();this.lastUpdateTime=t;var e,r=n(this.players);try{for(r.s();!(e=r.n()).done;){var i=a(e.value,2),o=i[0],s=i[1],l=s.currentMapId,h=this.mapManager.getMapById(l),u=this.mapGrids.get(l);h&&u?s.update(h,this):console.warn("Player ".concat(o," on unloaded map ").concat(l,". Skipping update."))}}catch(t){r.e(t)}finally{r.f()}var c,f=n(this.mapEnemies);try{for(f.s();!(c=f.n()).done;){var p=a(c.value,2),d=p[0],y=p[1],m=this.mapManager.getMapById(d),g=this.mapGrids.get(d);if(m&&g){this.currentMapId=d;var b,x=n(y);try{for(x.s();!(b=x.n()).done;){var w=a(b.value,2),M=(w[0],w[1]);M instanceof v?M.update(m,g,this):M.update(m,g)}}catch(t){x.e(t)}finally{x.f()}var S,C=this.mapBullets.get(d)||new Map,k=n(C);try{for(k.s();!(S=k.n()).done;){var T=a(S.value,2),I=T[0],O=T[1];O.isActive?O.update(m,g):(O.removeFromGrid(g),C.delete(I))}}catch(t){k.e(t)}finally{k.f()}}else console.warn("Skipping enemy updates for unloaded map ".concat(d,"."))}}catch(t){f.e(t)}finally{f.f()}this.checkCollisions(),this.broadcastGameState()}},{key:"checkCollisions",value:function(){var t,e=new Map,r=n(this.players.values());try{for(r.s();!(t=r.n()).done;){var i=t.value;e.has(i.currentMapId)||e.set(i.currentMapId,[]),e.get(i.currentMapId).push(i)}}catch(t){r.e(t)}finally{r.f()}var o,s=n(e);try{for(s.s();!(o=s.n()).done;){var l=a(o.value,2),h=l[0],u=l[1],c=this.mapGrids.get(h),f=this.mapEnemies.get(h),p=this.mapBullets.get(h)||new Map,d=this.mapManager.getMapById(h);if(c&&f&&d){var y,v=n(u);try{for(v.s();!(y=v.n()).done;){var m=y.value;if(!m.isDead){var g,b=m.radius+30,x=n(c.queryArea(m.x,m.y,b));try{for(x.s();!(g=x.n()).done;){var w=g.value,M=f.get(w);if(M){var S=m.x-M.x,C=m.y-M.y,k=m.radius+M.radius;if(S*S+C*C<k*k){m.hitByEnemy();break}}}}catch(t){x.e(t)}finally{x.f()}if(!m.isDead){var T,I=n(c.queryArea(m.x,m.y,b));try{for(I.s();!(T=I.n()).done;){var O=T.value,P=p.get(O);if(P&&P.isActive){var E=m.x-P.x,_=m.y-P.y,j=m.radius+P.radius;if(E*E+_*_<j*j){m.hitByEnemy(),P.isActive=!1;break}}}}catch(t){I.e(t)}finally{I.f()}}}}}catch(t){v.e(t)}finally{v.f()}for(var z=u.length,A=0;A<z;A++){var Y=u[A];if(!Y.isDead)for(var N=0;N<z;N++)if(A!==N){var B=u[N];if(B.isDead){var G=Y.x-B.x,F=Y.y-B.y,X=Y.radius+B.radius;G*G+F*F<X*X&&B.reviveByPlayer()}}}}}}catch(t){s.e(t)}finally{s.f()}}},{key:"handlePlayerTeleport",value:(r=u(l().mark((function t(e,r){var i,n,o,s,h,u,c,f,d,y,v,g,b,x,w,M,S,C,k,T,I,O;return l().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=this.players.get(e)){t.next=3;break}return t.abrupt("return");case 3:if(n=r.code,o=i.currentMapId,console.log("[GAME] Handling teleport for player ".concat(e.substring(0,8)," with code: ").concat(n)),n){t.next=9;break}return console.log("[GAME] Player ".concat(e.substring(0,8)," used a teleporter with no code. Ignoring.")),t.abrupt("return");case 9:s=null,h=0,u=Object.entries(this.mapManager.maps);case 11:if(!(h<u.length)){t.next=21;break}if(c=a(u[h],2),f=c[0],d=c[1],f===o){t.next=18;break}if(!d.getTeleporterByCode(n)){t.next=18;break}return s=f,t.abrupt("break",21);case 18:h++,t.next=11;break;case 21:if(s){t.next=24;break}return console.log("[GAME] Player ".concat(e.substring(0,8)," used teleporter with code ").concat(n," on ").concat(o,", but no destination map found.")),t.abrupt("return");case 24:return t.next=26,this.loadMapIfNeeded(s);case 26:if(y=t.sent){t.next=30;break}return console.error("[GAME] Teleport failed for player ".concat(e.substring(0,8),": Destination map ").concat(s," could not be loaded.")),t.abrupt("return");case 30:if(v=y.getTeleporterByCode(n)){t.next=34;break}return console.error("[GAME] Teleport failed for player ".concat(e.substring(0,8),": No teleporter with code ").concat(n," found on map ").concat(s,".")),t.abrupt("return");case 34:if(g=v.tileX*y.tileSize+y.tileSize/2,b=v.tileY*y.tileSize+y.tileSize/2,x=i.currentMapId,i.x=g,i.y=b,i.currentMapId=s,i.lastTeleporterCodeUsed=n,i.isOnTeleporter=!0,i.isFullyInsideTeleporter=!0,i.wasFullyOutsideTeleporter=!1,i.canTeleport=!1,i.teleporterCooldown=60,console.log("[GAME] Player ".concat(e.substring(0,8)," teleported from ").concat(x," to ").concat(s," at (").concat(g,", ").concat(b,") via teleporter with code ").concat(n)),(w=this.connections.get(e))&&1===w.readyState){M=this.mapEnemies.get(s)||new Map,S=Array.from(M.values()).map((function(t){return t.serialize()})),C=this.mapBullets.get(s)||new Map,k=Array.from(C.values()).filter((function(t){return t.isActive})).map((function(t){return t.serialize()})),T={type:"mapChange",newMapId:s,map:y.tiles,mapWidth:y.width,mapHeight:y.height,tileSize:y.tileSize,enemyTypes:m,enemies:S,bullets:k,playerData:i.serialize()},I=JSON.stringify(T);try{O=p.gzipSync(I),w.send(O)}catch(t){console.error("Failed to compress and send mapChange data:",t),w.send(I)}}this._idMapNeedsUpdate=!0;case 50:case"end":return t.stop()}}),t,this)}))),function(t,e){return r.apply(this,arguments)})},{key:"broadcastGameState",value:function(){var t=this;this._updateCounter++;var e=this._idMapNeedsUpdate||this._updateCounter<5;if(e){this._cachedPlayerIds.clear(),this._cachedEnemyIds.clear(),this._cachedBulletIds.clear(),this._playerIdCounter=1,this._enemyIdCounter=1,this._bulletIdCounter=1;var r,i=n(this.players.values());try{for(i.s();!(r=i.n()).done;){var o=r.value;this._cachedPlayerIds.has(o.id)||this._cachedPlayerIds.set(o.id,this._playerIdCounter++)}}catch(t){i.e(t)}finally{i.f()}var s,l=n(this.mapEnemies.values());try{for(l.s();!(s=l.n()).done;){var h,u=n(s.value.values());try{for(u.s();!(h=u.n()).done;){var c=h.value;this._cachedEnemyIds.has(c.id)||this._cachedEnemyIds.set(c.id,this._enemyIdCounter++)}}catch(t){u.e(t)}finally{u.f()}}}catch(t){l.e(t)}finally{l.f()}var f,d=n(this.mapBullets.values());try{for(d.s();!(f=d.n()).done;){var y,v=n(f.value.values());try{for(v.s();!(y=v.n()).done;){var m=y.value;this._cachedBulletIds.has(m.id)||this._cachedBulletIds.set(m.id,this._bulletIdCounter++)}}catch(t){v.e(t)}finally{v.f()}}}catch(t){d.e(t)}finally{d.f()}}var g,b=n(this.connections);try{for(b.s();!(g=b.n()).done;){var x=a(g.value,2),w=x[0],M=x[1];if(1===M.readyState){var S=this.players.get(w);if(S){var C,k=S.currentMapId,T=[],I=n(this.players.values());try{for(I.s();!(C=I.n()).done;){var O=C.value;O.currentMapId===k&&T.push(O)}}catch(t){I.e(t)}finally{I.f()}var P=this.mapEnemies.get(k)||new Map,E=this.mapBullets.get(k)||new Map,_={t:"u",p:T.map((function(e){return[t._cachedPlayerIds.get(e.id)||e.id,Math.round(e.x),Math.round(e.y),e.isDead?1:0]})),e:Array.from(P.values()).map((function(e){return[t._cachedEnemyIds.get(e.id)||e.id,e.type,Math.round(e.x),Math.round(e.y),e.radius]})),b:Array.from(E.values()).filter((function(t){return t.isActive})).map((function(e){return[t._cachedBulletIds.get(e.id)||e.id,Math.round(e.x),Math.round(e.y),e.radius]}))};if(e){_.idMap={p:{},e:{},b:{}};var j,z=n(T);try{for(z.s();!(j=z.n()).done;){var A=j.value,Y=this._cachedPlayerIds.get(A.id);Y&&(_.idMap.p[Y]=A.id)}}catch(t){z.e(t)}finally{z.f()}var N,B=n(P.values());try{for(B.s();!(N=B.n()).done;){var G=N.value,F=this._cachedEnemyIds.get(G.id);F&&(_.idMap.e[F]=G.id)}}catch(t){B.e(t)}finally{B.f()}var X,D=n(E.values());try{for(D.s();!(X=D.n()).done;){var W=X.value;if(W.isActive){var U=this._cachedBulletIds.get(W.id);U&&(_.idMap.b[U]=W.id)}}}catch(t){D.e(t)}finally{D.f()}}var R=JSON.stringify(_);try{var q=p.gzipSync(R);M.send(q)}catch(G){console.error("Failed to compress and send game state:",G)}}}}}catch(t){b.e(t)}finally{b.f()}e&&(this._idMapNeedsUpdate=!1)}},{key:"broadcastNewPlayer",value:function(t){var e,r={type:"newPlayer",player:t.serialize()},i=JSON.stringify(r),o=p.gzipSync(i),s=n(this.connections);try{for(s.s();!(e=s.n()).done;){var l=a(e.value,2),h=l[0],u=l[1],c=this.players.get(h);c&&c.id!==t.id&&c.currentMapId===t.currentMapId&&1===u.readyState&&u.send(o)}}catch(t){s.e(t)}finally{s.f()}}},{key:"broadcastPlayerLeave",value:function(t,e){var r,i={type:"playerLeave",playerId:t},o=JSON.stringify(i),s=p.gzipSync(o),l=n(this.connections);try{for(l.s();!(r=l.n()).done;){var h=a(r.value,2),u=h[0],c=h[1],f=this.players.get(u);f&&f.currentMapId===e&&1===c.readyState&&c.send(s)}}catch(t){l.e(t)}finally{l.f()}}}],e&&c(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,r,i,o}());t.exports={Game:b}},876:(t,e,r)=>{function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function a(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,s(i.key),i)}}function o(t,e,r){return e&&a(t.prototype,e),r&&a(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function s(t){var e=function(t){if("object"!=i(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=i(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==i(e)?e:e+""}var l=r(896),h=r(928),u=r(912).Map,c=function(){return o((function t(){n(this,t),this.maps={},this.currentMapId="map1",this.loadMaps()}),[{key:"loadMaps",value:function(){var t=this;["map1","map2","map3"].forEach((function(e){var r=h.join(__dirname,"maps","".concat(e,".json"));console.log("Loading map from: ".concat(r));try{var i=l.readFileSync(r,"utf8");console.log("File content read: ".concat(i.substring(0,50),"..."));var n=JSON.parse(i);console.log("Map data parsed: ".concat(Object.keys(n).join(", "))),n.mapId=e,t.maps[e]=new u(n),console.log("Map ".concat(e," loaded successfully"))}catch(t){console.error("Error loading map ".concat(e,":"),t)}}))}},{key:"getCurrentMap",value:function(){return this.maps[this.currentMapId]}},{key:"getMapById",value:function(t){return this.maps[t]||null}},{key:"changeMap",value:function(t){return!!this.maps[t]&&(this.currentMapId=t,!0)}}])}(),f=o((function t(){n(this,t);var e=h.join(__dirname,"maps","map1.json");console.log("Loading backward compatibility map from: ".concat(e));try{var r=l.readFileSync(e,"utf8"),i=JSON.parse(r);return i.mapId="map1",new u(i)}catch(t){return console.error("Error in MapBackwardCompatibility:",t),null}}));t.exports={MapManager:c,Map:f}},896:t=>{"use strict";t.exports=require("fs")},903:t=>{"use strict";t.exports=require("uuid")},912:t=>{function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e(t)}function r(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,i(n.key),n)}}function i(t){var r=function(t){if("object"!=e(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,"string");if("object"!=e(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(r)?r:r+""}var n=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.width=e.width,this.height=e.height,this.tileSize=e.tileSize,this.enemyConfig=e.enemyConfig,this.encodedMap=e.encodedMap,this.tiles=this.decodeMap(this.encodedMap),this.mapId=e.mapId||null,this.teleportersByPosition=new Map,this.teleportersByCode=new Map,this.findTeleporterTiles(),e.teleporterCodes&&(this.teleporterCodes=e.teleporterCodes,this.associateTeleporterCodes())},(e=[{key:"findTeleporterTiles",value:function(){for(var t=0;t<this.height;t++)for(var e=0;e<this.width;e++)if(3===this.tiles[t][e]){var r="".concat(e,"_").concat(t),i={tileX:e,tileY:t,code:null,mapId:null};this.teleportersByPosition.set(r,i)}}},{key:"associateTeleporterCodes",value:function(){if(this.teleporterCodes&&0!==this.teleporterCodes.length)for(var t=Array.from(this.teleportersByPosition.keys()),e=0;e<this.teleporterCodes.length;e++){var r=this.teleporterCodes[e];if(e<t.length){var i=t[e],n=this.teleportersByPosition.get(i);n.code=r.code,n.mapId=r.mapId,this.teleportersByCode.set(r.code,n)}}else console.warn("No teleporter codes available for map")}},{key:"decodeMap",value:function(t){for(var e=[],r=0,i=0,n=0;n<t.length;n+=2){var a=t[n],o=t[n+1];e[r]||(e[r]=[]);for(var s=0;s<o;s++)e[r][i]=a,++i>=this.width&&(i=0,++r<this.height&&!e[r]&&(e[r]=[]))}return e}},{key:"isWall",value:function(t,e){return t<0||e<0||t>=this.width||e>=this.height||0===this.tiles[e][t]}},{key:"getTileType",value:function(t,e){return t<0||e<0||t>=this.width||e>=this.height?0:this.tiles[e][t]}},{key:"isSafeZone",value:function(t,e){return!(t<0||e<0||t>=this.width||e>=this.height)&&2===this.tiles[e][t]}},{key:"getRandomTypePosition",value:function(t){for(var e=[],r=0;r<this.height;r++)for(var i=0;i<this.width;i++)this.tiles[r][i]===t&&e.push({x:i,y:r});if(0===e.length)return null;var n=e[Math.floor(Math.random()*e.length)];return{x:n.x*this.tileSize+this.tileSize/2,y:n.y*this.tileSize+this.tileSize/2}}},{key:"getValidSpawnPosition",value:function(t,e,r){for(var i=[],n=0;n<this.height;n++)for(var a=0;a<this.width;a++)if(this.getTileType(a,n)===t){var o=a*this.tileSize+this.tileSize/2,s=n*this.tileSize+this.tileSize/2;r.isValidSpawnPosition(o,s,e)&&i.push({x:o,y:s})}return 0===i.length?null:i[Math.floor(Math.random()*i.length)]}},{key:"isTeleporter",value:function(t,e){return 3===this.tiles[e][t]}},{key:"getTeleporter",value:function(t,e){var r="".concat(t,"_").concat(e);return this.teleportersByPosition.get(r)||null}},{key:"getTeleporterByCode",value:function(t){return this.teleportersByCode.get(t)||null}}])&&r(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();t.exports={Map:n}},928:t=>{"use strict";t.exports=require("path")}},e={};function r(i){var n=e[i];if(void 0!==n)return n.exports;var a=e[i]={exports:{}};return t[i](a,a.exports,r),a.exports}function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function n(){"use strict";n=function(){return e};var t,e={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},s=o.iterator||"@@iterator",l=o.asyncIterator||"@@asyncIterator",h=o.toStringTag||"@@toStringTag";function u(t,e,r,i){return Object.defineProperty(t,e,{value:r,enumerable:!i,configurable:!i,writable:!i})}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function c(e,r,i,n){var a=r&&r.prototype instanceof d?r:d,o=Object.create(a.prototype);return u(o,"_invoke",function(e,r,i){var n=1;return function(a,o){if(3===n)throw Error("Generator is already running");if(4===n){if("throw"===a)throw o;return{value:t,done:!0}}for(i.method=a,i.arg=o;;){var s=i.delegate;if(s){var l=S(s,i);if(l){if(l===p)continue;return l}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if(1===n)throw n=4,i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n=3;var h=f(e,r,i);if("normal"===h.type){if(n=i.done?4:2,h.arg===p)continue;return{value:h.arg,done:i.done}}"throw"===h.type&&(n=4,i.method="throw",i.arg=h.arg)}}}(e,i,new T(n||[])),!0),o}function f(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=c;var p={};function d(){}function y(){}function v(){}var m={};u(m,s,(function(){return this}));var g=Object.getPrototypeOf,b=g&&g(g(I([])));b&&b!==r&&a.call(b,s)&&(m=b);var x=v.prototype=d.prototype=Object.create(m);function w(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function M(t,e){function r(n,o,s,l){var h=f(t[n],t,o);if("throw"!==h.type){var u=h.arg,c=u.value;return c&&"object"==i(c)&&a.call(c,"__await")?e.resolve(c.__await).then((function(t){r("next",t,s,l)}),(function(t){r("throw",t,s,l)})):e.resolve(c).then((function(t){u.value=t,s(u)}),(function(t){return r("throw",t,s,l)}))}l(h.arg)}var n;u(this,"_invoke",(function(t,i){function a(){return new e((function(e,n){r(t,i,e,n)}))}return n=n?n.then(a,a):a()}),!0)}function S(e,r){var i=r.method,n=e.i[i];if(n===t)return r.delegate=null,"throw"===i&&e.i.return&&(r.method="return",r.arg=t,S(e,r),"throw"===r.method)||"return"!==i&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+i+"' method")),p;var a=f(n,e.i,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,p;var o=a.arg;return o?o.done?(r[e.r]=o.value,r.next=e.n,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,p):o:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,p)}function C(t){this.tryEntries.push(t)}function k(e){var r=e[4]||{};r.type="normal",r.arg=t,e[4]=r}function T(t){this.tryEntries=[[-1]],t.forEach(C,this),this.reset(!0)}function I(e){if(null!=e){var r=e[s];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function r(){for(;++n<e.length;)if(a.call(e,n))return r.value=e[n],r.done=!1,r;return r.value=t,r.done=!0,r};return o.next=o}}throw new TypeError(i(e)+" is not iterable")}return y.prototype=v,u(x,"constructor",v),u(v,"constructor",y),y.displayName=u(v,h,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===y||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,v):(t.__proto__=v,u(t,h,"GeneratorFunction")),t.prototype=Object.create(x),t},e.awrap=function(t){return{__await:t}},w(M.prototype),u(M.prototype,l,(function(){return this})),e.AsyncIterator=M,e.async=function(t,r,i,n,a){void 0===a&&(a=Promise);var o=new M(c(t,r,i,n),a);return e.isGeneratorFunction(r)?o:o.next().then((function(t){return t.done?t.value:o.next()}))},w(x),u(x,h,"Generator"),u(x,s,(function(){return this})),u(x,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var i in e)r.unshift(i);return function t(){for(;r.length;)if((i=r.pop())in e)return t.value=i,t.done=!1,t;return t.done=!0,t}},e.values=I,T.prototype={constructor:T,reset:function(e){if(this.prev=this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(k),!e)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0][4];if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function i(t){o.type="throw",o.arg=e,r.next=t}for(var n=r.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n],o=a[4],s=this.prev,l=a[1],h=a[2];if(-1===a[0])return i("end"),!1;if(!l&&!h)throw Error("try statement without catch or finally");if(null!=a[0]&&a[0]<=s){if(s<l)return this.method="next",this.arg=t,i(l),!0;if(s<h)return i(h),!1}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i[0]>-1&&i[0]<=this.prev&&this.prev<i[2]){var n=i;break}}n&&("break"===t||"continue"===t)&&n[0]<=e&&e<=n[2]&&(n=null);var a=n?n[4]:{};return a.type=t,a.arg=e,n?(this.method="next",this.next=n[2],p):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),p},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r[2]===t)return this.complete(r[4],r[3]),k(r),p}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r[0]===t){var i=r[4];if("throw"===i.type){var n=i.arg;k(r)}return n}}throw Error("illegal catch attempt")},delegateYield:function(e,r,i){return this.delegate={i:I(e),r,n:i},"next"===this.method&&(this.arg=t),p}},e}function a(t,e,r,i,n,a,o){try{var s=t[a](o),l=s.value}catch(t){return void r(t)}s.done?e(l):Promise.resolve(l).then(i,n)}var o=r(252),s=r(611),l=r(86),h=r(928),u=r(106),c=r(329).Player,f=r(654).Game,p=r(876).MapManager,d=r(422).ENEMY_TYPES,y=o(),v=s.createServer(y),m=new l.Server({server:v}),g=process.env.PORT||3e3,b=h.join(__dirname,"public");y.use(o.static(b,{setHeaders:function(t,e){e.endsWith(".js")&&t.setHeader("Content-Type","application/javascript")}})),y.get("/mapeditor",(function(t,e){e.sendFile(h.join(__dirname,"map_editor.html"))}));var x=new p,w=new f(x),M=new Map;function S(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=u.gzipSync(t);m.clients.forEach((function(t){t.readyState===l.OPEN&&t!==e&&t.send(r)}))}function C(t){if(!Buffer.isBuffer(t))return JSON.parse(t.toString());try{var e=u.gunzipSync(t);return JSON.parse(e.toString())}catch(e){try{var r=u.inflateSync(t);return JSON.parse(r.toString())}catch(e){return JSON.parse(t.toString())}}}m.on("connection",function(){var t,e=(t=n().mark((function t(e,r){var i,a,o,s,l,h,f,p,y,v,m;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=(null===(i=r.headers["x-forwarded-for"])||void 0===i||null===(i=i.split(",")[0])||void 0===i?void 0:i.trim())||r.socket.remoteAddress,!M.has(a)){t.next=4;break}return e.close(1008,"Only one connection per IP allowed"),t.abrupt("return");case 4:if(M.set(a,e),o="map1",s=x.getMapById(o)){t.next=11;break}return e.close(1011,"Server error: Default map not available."),M.delete(a),t.abrupt("return");case 11:return t.next=13,w.loadMapIfNeeded(o);case 13:if(l=s.getRandomTypePosition(2)){t.next=18;break}return e.close(1011,"Server error: No spawn on default map."),M.delete(a),t.abrupt("return");case 18:return h=new c(l.x,l.y,25,"#000000"),t.next=21,w.addPlayer(h,e,o);case 21:if(e.on("message",(function(t){try{var r=C(t);if("mousemove"===r.type||"m"===r.type&&void 0!==r.x&&void 0!==r.y)w.updatePlayerDirection(h.id,r.x,r.y);else if("ping"===r.type){var i=JSON.stringify({type:"pong",clientTime:r.time,serverTime:Date.now()});e.send(i)}else if("requestIdMap"===r.type)w._idMapNeedsUpdate=!0;else if("chat"===r.type)if("/reset"===r.message){var n=x.getMapById(h.currentMapId);if(n){var a=n.getRandomTypePosition(2);a&&(h.x=a.x,h.y=a.y,h.reset(),e.send(JSON.stringify({type:"respawn",x:a.x,y:a.y,currentMapId:h.currentMapId})))}}else{var o={type:"chat",sender:"Player ".concat(h.id.substring(0,6)),message:r.message};e.send(JSON.stringify(o)),S(JSON.stringify(o),e)}}catch(t){console.error("failed to parse message:",t)}})),e.on("close",(function(){w.removePlayer(h.id),M.delete(a)})),f=x.getMapById(h.currentMapId)){t.next=29;break}return w.removePlayer(h.id),M.delete(a),e.close(1011,"Server error: map data unavailable for player."),t.abrupt("return");case 29:p=w.mapEnemies.get(h.currentMapId)||new Map,y=Array.from(p.values()).map((function(t){return t.serialize()})),console.log("New player ".concat(h.id," joined on map ").concat(h.currentMapId)),v=JSON.stringify({type:"init",id:h.id,map:f.tiles,mapWidth:f.width,mapHeight:f.height,tileSize:f.tileSize,enemyTypes:d,enemies:y,playerData:h.serialize()}),w._idMapNeedsUpdate=!0,m=u.gzipSync(v),e.send(m);case 36:case"end":return t.stop()}}),t)})),function(){var e=this,r=arguments;return new Promise((function(i,n){var o=t.apply(e,r);function s(t){a(o,i,n,s,l,"next",t)}function l(t){a(o,i,n,s,l,"throw",t)}s(void 0)}))});return function(t,r){return e.apply(this,arguments)}}()),w.start(),v.listen(g,(function(){console.log("Server running on port ".concat(g))}))})();